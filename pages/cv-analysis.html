<!DOCTYPE html>
<html lang="pt-PT">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análise de CV com IA | Share2Inspire</title>
    <meta name="description" content="Analise o seu Curriculum Vitae com inteligência artificial.">

    <link rel="icon" href="../images/favicon.png" type="image/png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">
    <!-- Consolidated Styles: Design System + Header/Footer -->
    <link rel="stylesheet" href="../css/consolidated-styles.css">
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="../index.html">
                <img src="../images/logo.png" alt="Share2Inspire" height="50">
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="../index.html">Início</a></li>
                    <li class="nav-item"><a class="nav-link" href="people-hub.html">People Hub</a></li>
                    <li class="nav-item"><a class="nav-link" href="servicos.html">Serviços</a></li>
                    <li class="nav-item"><a class="nav-link active" href="cv-analysis.html">CV Analyser</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <section class="cv-hero py-5 mt-5" style="background: linear-gradient(135deg, #1A1A1A 0%, #333333 100%);">
        <div class="container text-center py-5">
            <h1 class="display-4 fw-bold text-white mb-3">Análise de CV Inteligente</h1>
            <p class="lead text-white-50 mb-0">Transforme o seu currículo numa ferramenta estratégica de carreira.</p>
        </div>
    </section>

    <section class="upload-section py-5">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-md-8 text-center">
                    <div class="maturity-score-card p-5">
                        <div class="icon-wrapper mb-4">
                            <i class="fas fa-cloud-upload-alt fa-4x" style="color: #BF9A33;"></i>
                        </div>
                        <h3 class="fw-bold">Carrega o teu CV</h3>
                        <p class="text-muted mb-4">O processamento é feito localmente e em tempo real.</p>

                        <div class="file-upload-wrapper">
                            <input type="file" id="cvFile" accept=".pdf,.docx" class="file-input" hidden>
                            <label for="cvFile" class="s2i-btn s2i-btn-outline">
                                <i class="fas fa-file-pdf me-2"></i> Selecionar PDF ou DOCX
                            </label>
                            <span id="fileName" class="d-block mt-3 text-muted fst-italic"></span>
                        </div>

                        <button id="analyzeBtn" class="s2i-btn s2i-btn-primary mt-4 px-5" disabled>
                            <span id="btnText">INICIAR ANÁLISE IA</span>
                            <span id="btnSpinner" class="spinner-border spinner-border-sm ms-2 d-none"></span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <div class="modal fade" id="resultsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header"
                    style="background: linear-gradient(135deg, #1A1A1A 0%, #2d2d2d 100%); border-bottom: none; padding: 1.75rem 2rem 1.25rem 2rem;">
                    <div style="width: 100%;">
                        <h5 class="modal-title text-white"
                            style="font-weight: 500; font-size: 1.35rem; margin-bottom: 0.5rem;">Análise Inicial do
                            Perfil</h5>
                        <p class="text-white" style="font-size: 0.875rem; opacity: 0.85; margin: 0;">Leitura automática
                            do teu CV, baseada em estrutura, conteúdo e posicionamento.</p>
                    </div>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        style="opacity: 0.7;"></button>
                </div>
                <div class="modal-body p-4" style="background: #f8f9fa;">

                    <!-- BLOCO 1: Retrato Profissional -->
                    <div class="analysis-block mb-4 p-3"
                        style="background: white; border-radius: 8px; border-left: 3px solid #BF9A33;">
                        <h6 style="font-size: 0.95rem; font-weight: 600; color: #1A1A1A; margin-bottom: 1rem;">Retrato
                            Profissional</h6>
                        <div style="font-size: 0.875rem; color: #495057; line-height: 1.7;">
                            <div class="mb-2"><strong>Anos de experiência identificados:</strong> <span id="yearsExp">A
                                    calcular...</span></div>
                            <div class="mb-2"><strong>Área principal de especialização:</strong> <span id="mainArea">A
                                    identificar...</span></div>
                            <div class="mb-3"><strong>Nível de senioridade estimado:</strong> <span
                                    id="seniorityLevel">A avaliar...</span></div>
                            <p style="font-size: 0.8rem; color: #6c757d; margin: 0; font-style: italic;">Esta leitura
                                resulta da análise do percurso, funções descritas e progressão temporal.</p>
                        </div>
                    </div>

                    <!-- BLOCO 2: Maturidade e Posicionamento -->
                    <div class="analysis-block mb-4 p-3"
                        style="background: white; border-radius: 8px; text-align: center;">
                        <h6 style="font-size: 0.95rem; font-weight: 600; color: #1A1A1A; margin-bottom: 0.75rem;">
                            Maturidade Profissional</h6>
                        <div class="display-3 fw-bold mb-2" style="color: #BF9A33;" id="maturityScore">0.0</div>
                        <div style="font-size: 0.8rem; color: #6c757d; margin-bottom: 0.75rem;">/ 5</div>
                        <div class="badge px-3 py-2 mb-3" style="background: #1A1A1A; color: white; font-size: 0.85rem;"
                            id="maturityLabel">Em Análise</div>
                        <p style="font-size: 0.8rem; color: #6c757d; margin: 0; font-style: italic;">O score reflete
                            coerência de percurso, clareza narrativa e alinhamento com o mercado.</p>
                    </div>

                    <!-- BLOCO 3: Leitura do Perfil -->
                    <div class="analysis-block mb-4 p-3" style="background: white; border-radius: 8px;">
                        <h6 style="font-size: 0.95rem; font-weight: 600; color: #1A1A1A; margin-bottom: 1rem;">Leitura
                            do Perfil</h6>
                        <ul style="list-style: none; padding: 0; margin: 0; font-size: 0.875rem; color: #495057;">
                            <li class="mb-2">• Clareza do papel profissional atual</li>
                            <li class="mb-2">• Consistência entre experiência e objetivos</li>
                            <li class="mb-2">• Grau de especialização versus generalismo</li>
                            <li>• Presença ou ausência de foco estratégico</li>
                        </ul>
                    </div>

                    <!-- BLOCO 4: Competências Identificadas -->
                    <div class="analysis-block mb-4 p-3" style="background: white; border-radius: 8px;">
                        <h6 class="mb-3" style="font-size: 0.95rem; font-weight: 600; color: #1A1A1A;">Competências
                            Detetadas</h6>
                        <div class="mb-3">
                            <div style="font-size: 0.8rem; font-weight: 600; color: #6c757d; margin-bottom: 0.5rem;">
                                HARD SKILLS</div>
                            <div id="hardSkillsList" style="font-size: 0.875rem; color: #495057;">A identificar...</div>
                        </div>
                        <div class="mb-3">
                            <div style="font-size: 0.8rem; font-weight: 600; color: #6c757d; margin-bottom: 0.5rem;">
                                SOFT SKILLS</div>
                            <div id="softSkillsList" style="font-size: 0.875rem; color: #495057;">A identificar...</div>
                        </div>
                        <div class="mb-3">
                            <div style="font-size: 0.8rem; font-weight: 600; color: #6c757d; margin-bottom: 0.5rem;">
                                IDIOMAS</div>
                            <div id="languagesList" style="font-size: 0.875rem; color: #495057;">A identificar...</div>
                        </div>
                        <p style="font-size: 0.8rem; color: #6c757d; margin: 0; font-style: italic;">A análise baseia-se
                            apenas no que está explícito no documento.</p>
                    </div>

                    <!-- BLOCO 5: Formação e Atualização -->
                    <div class="analysis-block mb-4 p-3" style="background: white; border-radius: 8px;">
                        <h6 style="font-size: 0.95rem; font-weight: 600; color: #1A1A1A; margin-bottom: 1rem;">
                            Aprendizagem e Atualização</h6>
                        <div style="font-size: 0.875rem; color: #495057; line-height: 1.7;">
                            <div class="mb-2"><strong>Última formação identificada:</strong> <span id="lastEducation">A
                                    verificar...</span></div>
                            <div class="mb-3"><strong>Ritmo de atualização:</strong> <span id="updateRhythm">A
                                    avaliar...</span></div>
                            <p style="font-size: 0.8rem; color: #6c757d; margin: 0; font-style: italic;">A frequência
                                formativa influencia diretamente empregabilidade e mobilidade.</p>
                        </div>
                    </div>

                    <!-- BLOCO 6: Estrutura e ATS -->
                    <div class="analysis-block mb-4 p-3" style="background: white; border-radius: 8px;">
                        <h6 style="font-size: 0.95rem; font-weight: 600; color: #1A1A1A; margin-bottom: 1rem;">Estrutura
                            e Readiness para ATS</h6>
                        <div style="font-size: 0.875rem; color: #495057; line-height: 1.7;">
                            <div class="mb-2"><strong>Compatibilidade ATS:</strong> <span id="atsCompat">A
                                    avaliar...</span></div>
                            <div class="mb-2"><strong>Estrutura do CV:</strong> <span id="cvStructure">A
                                    verificar...</span></div>
                            <div class="mb-3"><strong>Legibilidade e hierarquia visual:</strong> <span
                                    id="readability">A analisar...</span></div>
                            <p style="font-size: 0.8rem; color: #6c757d; margin: 0; font-style: italic;">Pequenos
                                ajustes estruturais podem ter impacto significativo na triagem automática.</p>
                        </div>
                    </div>

                    <!-- BLOCO VISUAL: Radar Chart -->
                    <div class="analysis-block mb-4 p-3" style="background: white; border-radius: 8px;">
                        <div class="chart-container" style="height: 280px;">
                            <canvas id="radarChart"></canvas>
                        </div>
                        <p
                            style="font-size: 0.8rem; color: #6c757d; text-align: center; margin: 0.75rem 0 0 0; font-style: italic;">
                            Leitura comparativa entre estrutura, impacto, posicionamento, mercado e ATS.</p>
                    </div>

                    <!-- BLOCO FINAL: Teaser do Relatório -->
                    <div class="analysis-block p-4"
                        style="background: white; border-radius: 8px; border: 2px solid #BF9A33;">
                        <div style="text-align: center; color: #BF9A33; margin-bottom: 1rem;">
                            <i class="fas fa-file-alt" style="font-size: 2rem;"></i>
                        </div>
                        <h6
                            style="font-size: 1rem; font-weight: 600; color: #1A1A1A; text-align: center; margin-bottom: 0.75rem;">
                            O que não está aqui</h6>
                        <p style="font-size: 0.875rem; color: #495057; text-align: center; margin-bottom: 1rem;">Esta é
                            uma leitura inicial.<br>O relatório completo aprofunda decisões, riscos e oportunidades
                            específicas do teu perfil.</p>
                        <div style="font-size: 0.875rem; color: #495057; margin-bottom: 1.25rem;">
                            <div style="margin-bottom: 0.5rem;"><strong>Inclui</strong></div>
                            <ul style="list-style: none; padding-left: 1rem; margin: 0;">
                                <li class="mb-1">• Diagnóstico detalhado</li>
                                <li class="mb-1">• Pontos fortes e fragilidades reais</li>
                                <li class="mb-1">• Recomendações acionáveis</li>
                                <li>• Plano de evolução personalizado</li>
                            </ul>
                        </div>
                        <div style="text-align: center; margin-bottom: 1.25rem;">
                            <div style="font-size: 1.75rem; font-weight: 600; color: #BF9A33;">1,00 €</div>
                            <div style="font-size: 0.85rem; color: #6c757d;">Relatório PDF enviado por email</div>
                        </div>
                    </div>

                </div>
                <div class="modal-footer bg-white border-top" style="padding: 1.25rem 2rem;">
                    <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-dismiss="modal"
                        style="border-radius: 6px;">Fechar</button>
                    <button type="button"
                        style="background: #BF9A33; color: white; border: none; border-radius: 6px; padding: 0.65rem 1.75rem; font-size: 0.95rem; font-weight: 500;"
                        onclick="openReportPaymentModal()">
                        Desbloquear relatório completo
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Modal for 1€ PDF Report -->
    <div class="modal fade" id="reportPaymentModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" style="max-width: 500px;">
            <div class="modal-content" style="border-radius: 16px; border: none;">
                <div class="modal-header border-0">
                    <div style="text-align: center; width: 100%;">
                        <h5 class="modal-title fw-bold" style="font-size: 1.3rem; color: #1A1A1A;">Análise Automática de
                            CV</h5>
                        <p class="text-muted mb-0" style="font-size: 0.85rem;">Diagnóstico rápido baseado em IA</p>
                    </div>
                    <button type="button" class="btn-close position-absolute end-0 top-0 m-3"
                        data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body px-4 py-3">

                    <!-- Info Note -->
                    <div class="mb-3"
                        style="background: #f8f9fa; border-left: 3px solid #BF9A33; padding: 0.75rem; border-radius: 6px;">
                        <div style="display: flex; gap: 8px; align-items: start; font-size: 0.85rem; color: #1A1A1A;">
                            <span style="color: #BF9A33; flex-shrink: 0;">①</span>
                            <span>Sistema analisa estrutura, keywords e formatação</span>
                        </div>
                        <div
                            style="display: flex; gap: 8px; align-items: start; font-size: 0.85rem; color: #1A1A1A; margin-top: 0.5rem;">
                            <span style="color: #BF9A33; flex-shrink: 0;">②</span>
                            <span>Recebes relatório PDF no email em segundos</span>
                        </div>
                        <small class="d-block mt-2" style="color: #6c757d; font-size: 0.75rem;">⏱ Tempo total: ~2
                            minutos</small>
                    </div>

                    <!-- PAYMENT FORM -->
                    <form id="reportPaymentForm">
                        <div class="mb-3">
                            <label class="form-label"
                                style="font-weight: 500; font-size: 0.9rem; color: #1A1A1A;">Nome</label>
                            <input type="text" class="form-control" id="paymentName" required
                                style="border: 1px solid #dee2e6; border-radius: 6px; padding: 0.6rem;">
                        </div>
                        <div class="mb-3">
                            <label class="form-label"
                                style="font-weight: 500; font-size: 0.9rem; color: #1A1A1A;">Email</label>
                            <input type="email" class="form-control" id="paymentEmail" required
                                style="border: 1px solid #dee2e6; border-radius: 6px; padding: 0.6rem;">
                        </div>
                        <div class="mb-3">
                            <label class="form-label"
                                style="font-weight: 500; font-size: 0.9rem; color: #1A1A1A;">Telemóvel</label>
                            <input type="tel" class="form-control" id="paymentPhone" required placeholder="961925050"
                                pattern="[0-9]{9}"
                                style="border: 1px solid #dee2e6; border-radius: 6px; padding: 0.6rem;">
                            <small class="form-text" style="font-size: 0.75rem; color: #6c757d; margin-top: 0.25rem;">
                                Pagamento seguro via MB WAY. Receberás notificação na app.
                            </small>
                        </div>

                        <div id="paymentStatusMsg" class="d-none"></div>

                        <button type="submit" class="btn w-100 mt-2 py-2" id="btnPayReport"
                            style="background: #BF9A33; border: none; color: #fff; font-weight: 600; font-size: 0.95rem; border-radius: 6px;">
                            Receber Relatório (1€ via MB WAY)
                        </button>
                    </form>

                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- PDF.js & Mammoth.js for Real File Reading -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Project Scripts -->
    <script src="../js/ifthenpay-integration.js"></script>
    <script src="../js/cv-engine.js"></script>
    <script src="../js/pdf-generator.js"></script>

    <script>
        const fileInput = document.getElementById('cvFile');
        const fileNameDisplay = document.getElementById('fileName');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const btnSpinner = document.getElementById('btnSpinner');
        const btnText = document.getElementById('btnText');

        // Mostrar nome do ficheiro selecionado
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                fileNameDisplay.textContent = e.target.files[0].name;
                analyzeBtn.disabled = false;
            }
        });

        // Clique no Botão Analisar - REAL FILE PROCESSING
        analyzeBtn.addEventListener('click', async () => {
            // UI Loading
            analyzeBtn.disabled = true;
            btnSpinner.classList.remove('d-none');
            btnText.textContent = 'A LER & ANALISAR...';

            const file = fileInput.files[0];

            if (file) {
                try {
                    // Chamar o Motor de Análise Real (PDF.js + Mammoth.js + Heuristics)
                    const success = await window.CV_ENGINE.analyzeFile(file);

                    if (success) {
                        // Abrir Modal com Resultados
                        const modal = new bootstrap.Modal(document.getElementById('resultsModal'));
                        modal.show();
                    }
                } catch (error) {
                    alert('Erro ao processar ficheiro: ' + error.message);
                    console.error('[CV ANALYSIS] Error:', error);
                }
            }

            // Reset UI
            analyzeBtn.disabled = false;
            btnSpinner.classList.add('d-none');
            btnText.textContent = 'INICIAR ANÁLISE IA';
        });

        // Função Global para desenhar o gráfico (chamada pelo cv-engine.js)
        window.renderRadarChart = (competencies) => {
            const ctx = document.getElementById('radarChart').getContext('2d');

            // Destruir gráfico anterior se existir
            if (window.myRadarChart) window.myRadarChart.destroy();

            window.myRadarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['ATS', 'Impacto', 'Estrutura', 'Mercado', 'Posicionamento'],
                    datasets: [{
                        label: 'O Teu Perfil',
                        data: [
                            competencies.ats,
                            competencies.impact,
                            competencies.structure,
                            competencies.market,
                            competencies.positioning
                        ],
                        backgroundColor: 'rgba(191, 154, 51, 0.25)',
                        borderColor: '#BF9A33',
                        borderWidth: 2,
                        pointBackgroundColor: '#BF9A33',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: '#BF9A33'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                stepSize: 20,
                                display: true,
                                backdropColor: 'transparent'
                            },
                            grid: {
                                color: '#e0e0e0'
                            },
                            angleLines: {
                                color: '#e0e0e0'
                            },
                            pointLabels: {
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return context.label + ': ' + context.parsed.r + '/100';
                                }
                            }
                        }
                    }
                }
            });
        };

        // Open Payment Modal Function
        function openReportPaymentModal() {
            // Close results modal
            const resultsModalEl = document.getElementById('resultsModal');
            if (resultsModalEl) {
                const resultsModal = bootstrap.Modal.getInstance(resultsModalEl);
                if (resultsModal) resultsModal.hide();
            }

            // Open payment modal
            const paymentModal = new bootstrap.Modal(document.getElementById('reportPaymentModal'));
            paymentModal.show();
        }

        // Handle Payment Form Submission
        document.getElementById('reportPaymentForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();

            const name = document.getElementById('paymentName').value.trim();
            const email = document.getElementById('paymentEmail').value.trim();
            const phone = document.getElementById('paymentPhone').value.replace(/\D/g, ''); // Remove non-digits

            if (!name || !email || !phone) {
                alert('Por favor, preencha todos os campos.');
                return;
            }

            if (phone.length !== 9) {
                alert('O número de telemóvel deve ter 9 dígitos.');
                return;
            }

            const btnPayReport = document.getElementById('btnPayReport');
            const statusMsg = document.getElementById('paymentStatusMsg');
            const originalBtnText = btnPayReport.innerHTML;

            // Set loading state
            btnPayReport.disabled = true;
            btnPayReport.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> A processar...';
            statusMsg.classList.remove('d-none');
            statusMsg.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i> A iniciar pagamento MB WAY...</div>';

            try {
                // Call backend to initiate payment
                const BACKEND_URL = 'https://share2inspire-beckend.lm.r.appspot.com';
                const response = await fetch(`${BACKEND_URL}/api/services/cv-analyzer-payment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: name,
                        email: email,
                        phone: phone,
                        amount: '1.00',
                        reportData: window.CV_ENGINE?.data || {}
                    })
                });

                const result = await response.json();

                if (!response.ok || !result.success) {
                    throw new Error(result.error || 'Erro ao processar pagamento');
                }

                // Payment initiated successfully
                statusMsg.innerHTML = `
                    <div class="alert alert-success">
                        <i class="fas fa-mobile-alt me-2"></i>
                        <strong>Pedido MB WAY enviado!</strong><br>
                        <small>Por favor, confirme na sua aplicação MB WAY. Aguardamos confirmação...</small>
                    </div>
                `;

                // Start polling for payment confirmation
                const orderId = result.order_id || result.orderId;
                pollPaymentStatus(orderId, name, email, BACKEND_URL);

            } catch (error) {
                console.error('Payment Error:', error);
                statusMsg.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i> ${error.message}</div>`;
                btnPayReport.disabled = false;
                btnPayReport.innerHTML = originalBtnText;
            }
        });

        // Poll Payment Status
        async function pollPaymentStatus(orderId, name, email, backendUrl) {
            const statusMsg = document.getElementById('paymentStatusMsg');
            let pollCount = 0;
            const maxPolls = 60; // 3 minutes (3s * 60)

            const checkStatus = async () => {
                try {
                    const response = await fetch(`${backendUrl}/api/payment/status/${orderId}`);
                    const data = await response.json();

                    if (data.success && data.paid) {
                        // Payment confirmed!
                        statusMsg.innerHTML = `
                            <div class="alert alert-success">
                                <i class="fas fa-check-circle me-2"></i>
                                <strong>Pagamento confirmado!</strong><br>
                                <small>A gerar e enviar relatório PDF para ${email}...</small>
                            </div>
                        `;

                        // Trigger report delivery
                        await deliverPDFReport(name, email, backendUrl);

                        // Final success message
                        statusMsg.innerHTML = `
                            <div class="alert alert-success">
                                <i class="fas fa-envelope-open-text me-2"></i>
                                <strong>Relatório enviado com sucesso!</strong><br>
                                <small>Verifique o seu email ${email}</small>
                            </div>
                        `;

                        setTimeout(() => {
                            bootstrap.Modal.getInstance(document.getElementById('reportPaymentModal')).hide();
                        }, 4000);

                        return; // Stop polling
                    }

                    // Continue polling
                    pollCount++;
                    if (pollCount < maxPolls) {
                        setTimeout(checkStatus, 3000); // Check every 3 seconds
                    } else {
                        // Timeout
                        statusMsg.innerHTML += '<div class="alert alert-warning small mt-2">Tempo de espera excedido. Se confirmou o pagamento, receberá o relatório por email em breve.</div>';
                    }

                } catch (error) {
                    console.error('Polling error:', error);
                }
            };

            // Start polling after 2 seconds
            setTimeout(checkStatus, 2000);
        }

        // Deliver PDF Report
        async function deliverPDFReport(name, email, backendUrl) {
            const reportData = window.CV_ENGINE?.data || {};

            await fetch(`${backendUrl}/api/services/deliver-cv-report`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name: name,
                    email: email,
                    report: reportData
                })
            });
        }
    </script>
</body>

</html>