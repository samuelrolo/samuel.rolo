<!DOCTYPE html>
<html lang="pt-PT">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>An√°lise de CV com IA | Share2Inspire</title>
    <meta name="description" content="Analise o seu Curriculum Vitae com intelig√™ncia artificial.">

    <link rel="icon" href="../images/favicon.png" type="image/png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">
    <!-- Consolidated Styles: Design System + Header/Footer -->
    <link rel="stylesheet" href="../css/consolidated-styles.css">
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="../index.html">
                <img src="../images/logo.png" alt="Share2Inspire" height="50">
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="../index.html">In√≠cio</a></li>
                    <li class="nav-item"><a class="nav-link" href="sobre.html">Sobre</a></li>
                    <li class="nav-item"><a class="nav-link" href="servicos.html">Servi√ßos</a></li>
                    <li class="nav-item"><a class="nav-link active" href="cv-analysis.html">CV Analyser</a></li>
                    <li class="nav-item"><a class="nav-link" href="loja.html">Loja</a></li>
                    <li class="nav-item"><a class="nav-link" href="people-hub.html">People Hub</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <section class="cv-hero py-5 mt-5" style="background: linear-gradient(135deg, #1A1A1A 0%, #333333 100%);">
        <div class="container text-center py-5">
            <h1 class="display-4 fw-bold text-white mb-3">An√°lise de CV <span style="color: #BF9A33;">Inteligente</span>
            </h1>
            <p class="lead text-white-50 mb-0">Transforma o teu curr√≠culo numa ferramenta estrat√©gica de carreira com
                feedback personalizado em tempo real.</p>
        </div>
    </section>

    <section class="upload-section py-5">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-md-8 text-center">
                    <div class="maturity-score-card p-5">
                        <div class="icon-wrapper mb-4">
                            <i class="fas fa-cloud-upload-alt fa-4x" style="color: #BF9A33;"></i>
                        </div>
                        <h3 class="fw-bold">Carrega o teu CV</h3>
                        <p class="text-muted mb-4">O processamento √© feito localmente e em tempo real.</p>

                        <div class="file-upload-wrapper">
                            <input type="file" id="cvFile" accept=".pdf,.docx" class="file-input" hidden>
                            <label for="cvFile" class="s2i-btn s2i-btn-outline">
                                <i class="fas fa-file-pdf me-2"></i>Analisar CV
                            </label>
                            <span id="fileName" class="d-block mt-3 text-muted fst-italic"></span>
                        </div>

                        <button id="analyzeBtn" class="s2i-btn s2i-btn-primary mt-4 px-5" disabled>
                            <span id="btnText">INICIAR AN√ÅLISE IA</span>
                            <span id="btnSpinner" class="spinner-border spinner-border-sm ms-2 d-none"></span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <div class="modal fade" id="resultsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable modal-dialog-centered" style="max-width: 95%;">
            <div class="modal-content">
                <div class="modal-header"
                    style="background: linear-gradient(135deg, #1A1A1A 0%, #2d2d2d 100%); border-bottom: none; padding: 1.75rem 2rem 1.25rem 2rem;">
                    <div style="width: 100%;">
                        <h5 class="modal-title text-white"
                            style="font-weight: 500; font-size: 1.35rem; margin-bottom: 0.5rem;">An√°lise Inicial do
                            Perfil</h5>
                        <p class="text-white" style="font-size: 0.875rem; opacity: 0.85; margin: 0;">Leitura autom√°tica
                            do teu CV, baseada em estrutura, conte√∫do e posicionamento.</p>
                    </div>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4" style="background: #f8f9fa;">

                    <!-- TOP SECTION: Two Columns -->
                    <div class="row mb-4">
                        <!-- LEFT: Retrato Profissional + Leitura do Perfil -->
                        <div class="col-md-6">
                            <div class="analysis-block p-3 mb-3"
                                style="background: white; border-radius: 8px; border-left: 3px solid #BF9A33; height: 100%;">
                                <h6 style="font-size: 0.9rem; font-weight: 500; color: #333; margin-bottom: 1rem;">
                                    üë§ Retrato Profissional</h6>
                                <div style="font-size: 0.85rem; font-weight: 400; color: #555; line-height: 1.8;">
                                    <div class="mb-2"><strong>Anos de experi√™ncia:</strong> <span id="yearsExp">A
                                            calcular...</span></div>
                                    <div class="mb-2"><strong>√Årea principal:</strong> <span id="mainArea">A
                                            identificar...</span></div>
                                    <div class="mb-3"><strong>N√≠vel de senioridade:</strong> <span id="seniorityLevel">A
                                            avaliar...</span></div>

                                    <!-- Leitura do Perfil integrada -->
                                    <div class="mt-3 pt-3" style="border-top: 1px solid #e9ecef;">
                                        <div
                                            style="font-size: 0.8rem; font-weight: 500; color: #888; letter-spacing: 0.5px; margin-bottom: 0.5rem;">
                                            üìã LEITURA DO PERFIL</div>
                                        <ul
                                            style="list-style: none; padding: 0; margin: 0; font-size: 0.8rem; font-weight: 400; color: #666;">
                                            <li class="mb-2">‚Ä¢ Clareza do papel profissional atual</li>
                                            <li class="mb-2">‚Ä¢ Consist√™ncia entre experi√™ncia e objetivos</li>
                                            <li class="mb-2">‚Ä¢ Grau de especializa√ß√£o versus generalismo</li>
                                            <li>‚Ä¢ Presen√ßa ou aus√™ncia de foco estrat√©gico</li>
                                        </ul>
                                    </div>

                                    <p
                                        style="font-size: 0.75rem; color: #6c757d; margin: 0.75rem 0 0 0; font-style: italic;">
                                        Esta leitura resulta da an√°lise do percurso, fun√ß√µes e progress√£o temporal.</p>
                                </div>
                            </div>
                        </div>

                        <!-- RIGHT: Resumo Global AI (Gemini) -->
                        <div class="col-md-6">
                            <div class="analysis-block p-3"
                                style="background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); border-radius: 8px; border-left: 3px solid #BF9A33; height: 100%;">
                                <h6 style="font-size: 0.9rem; font-weight: 500; color: #333; margin-bottom: 1rem;">
                                    <i class="fas fa-brain" style="color: #BF9A33; margin-right: 8px;"></i>
                                    Resumo Global AI
                                </h6>
                                <div id="geminiGlobalSummary"
                                    style="font-size: 0.85rem; font-weight: 400; color: #555; line-height: 1.8; min-height: 120px;">
                                    <p class="text-muted fst-italic">A gerar an√°lise inteligente do CV...</p>
                                </div>

                                <!-- Pontos Fortes AI -->
                                <div class="mt-3 pt-3" style="border-top: 1px solid #e9ecef;">
                                    <div
                                        style="font-size: 0.8rem; font-weight: 500; color: #28a745; letter-spacing: 0.5px; margin-bottom: 0.5rem;">
                                        ‚úÖ PONTOS FORTES IDENTIFICADOS
                                    </div>
                                    <ul id="aiStrengths"
                                        style="list-style: none; padding: 0; margin: 0; font-size: 0.8rem; font-weight: 400; color: #666;">
                                        <li class="mb-1">‚Ä¢ A analisar...</li>
                                    </ul>
                                </div>

                                <p
                                    style="font-size: 0.75rem; color: #6c757d; margin: 0.75rem 0 0 0; font-style: italic;">
                                    <i class="fas fa-robot"></i> An√°lise gerada por Gemini AI
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- BLOCO 2: Maturidade e Posicionamento -->
                    <div class="analysis-block mb-4 p-3"
                        style="background: white; border-radius: 8px; text-align: center;">
                        <h6 style="font-size: 0.95rem; font-weight: 600; color: #1A1A1A; margin-bottom: 0.75rem;">
                            <i class="fas fa-chart-line" style="color: #BF9A33; margin-right: 8px;"></i>
                            Maturidade Profissional
                        </h6>
                        <div class="display-3 fw-bold mb-2" style="color: #BF9A33;" id="maturityScore">--</div>
                        <div style="font-size: 0.8rem; color: #6c757d; margin-bottom: 0.5rem;">/100</div>

                        <!-- Barra de Progresso Maturidade -->
                        <div style="width: 100%; max-width: 300px; margin: 0 auto 0.75rem auto;">
                            <div style="background: #e9ecef; border-radius: 10px; height: 12px; overflow: hidden;">
                                <div id="maturityProgressBar"
                                    style="background: linear-gradient(90deg, #BF9A33 0%, #d4af37 100%); height: 100%; width: 0%; border-radius: 10px; transition: width 1s ease-out;">
                                </div>
                            </div>
                        </div>

                        <div class="badge px-3 py-2 mb-3" style="background: #1A1A1A; color: white; font-size: 0.85rem;"
                            id="maturityLabel">Em An√°lise</div>
                        <p style="font-size: 0.8rem; color: #6c757d; margin: 0; font-style: italic;">O score reflete
                            coer√™ncia de percurso, clareza narrativa e alinhamento com o mercado.</p>
                    </div>

                    <!-- BLOCO 4: Compet√™ncias Identificadas -->
                    <div class="analysis-block mb-4 p-3" style="background: white; border-radius: 8px;">
                        <h6 class="mb-3" style="font-size: 0.95rem; font-weight: 600; color: #1A1A1A;">Compet√™ncias
                            Detetadas</h6>
                        <div class="mb-3">
                            <div style="font-size: 0.8rem; font-weight: 600; color: #6c757d; margin-bottom: 0.5rem;">
                                HARD SKILLS</div>
                            <div id="hardSkillsList" style="font-size: 0.875rem; color: #495057;">A identificar...</div>
                        </div>
                        <div class="mb-3">
                            <div style="font-size: 0.8rem; font-weight: 600; color: #6c757d; margin-bottom: 0.5rem;">
                                SOFT SKILLS</div>
                            <div id="softSkillsList" style="font-size: 0.875rem; color: #495057;">A identificar...</div>
                        </div>
                        <div class="mb-3">
                            <div style="font-size: 0.8rem; font-weight: 600; color: #6c757d; margin-bottom: 0.5rem;">
                                IDIOMAS</div>
                            <div id="languagesList" style="font-size: 0.875rem; color: #495057;">A identificar...</div>
                        </div>
                        <p style="font-size: 0.8rem; color: #6c757d; margin: 0; font-style: italic;">A an√°lise baseia-se
                            apenas no que est√° expl√≠cito no documento.</p>
                    </div>

                    <!-- BLOCO 5: Forma√ß√£o e Atualiza√ß√£o -->
                    <div class="analysis-block mb-4 p-3" style="background: white; border-radius: 8px;">
                        <h6 style="font-size: 0.95rem; font-weight: 600; color: #1A1A1A; margin-bottom: 1rem;">
                            Aprendizagem e Forma√ß√£o</h6>
                        <div style="font-size: 0.875rem; color: #495057; line-height: 1.7;">
                            <div class="mb-2"><strong>√öltima forma√ß√£o identificada:</strong> <span id="lastEducation">A
                                    verificar...</span></div>
                            <div class="mb-3"><strong>Ritmo de atualiza√ß√£o:</strong> <span id="updateRhythm">A
                                    avaliar...</span></div>

                            <!-- AN√ÅLISE AI DE RELEV√ÇNCIA DE FORMA√á√ÉO -->
                            <div id="trainingRelevanceSection" class="mt-3 pt-3"
                                style="border-top: 1px solid #e9ecef; display: none;">
                                <div
                                    style="display: inline-block; padding: 4px 12px; border-radius: 4px; background: #d1fae5; color: #059669; font-size: 0.75rem; font-weight: 600; letter-spacing: 0.5px; margin-bottom: 0.75rem;">
                                    RELEV√ÇNCIA PARA A √ÅREA
                                </div>
                                <div class="mb-2">
                                    <strong>Score de Alinhamento:</strong>
                                    <span id="trainingScore" style="color: #059669; font-weight: 600;">--/100</span>
                                </div>
                                <div class="mb-3" id="trainingAssessment"
                                    style="font-size: 0.85rem; color: #6c757d; font-style: italic;">
                                    An√°lise AI em processamento...
                                </div>

                                <div id="alignedCoursesDiv" style="display: none;" class="mb-2">
                                    <strong style="font-size: 0.85rem;">Forma√ß√µes Relevantes:</strong>
                                    <ul id="alignedCoursesList"
                                        style="font-size: 0.825rem; margin: 0.5rem 0; padding-left: 1.2rem;">
                                    </ul>
                                </div>

                                <div id="recommendedCoursesDiv" style="display: none;">
                                    <strong style="font-size: 0.85rem; color: #BF9A33;">Recomenda√ß√µes:</strong>
                                    <ul id="recommendedCoursesList"
                                        style="font-size: 0.825rem; margin: 0.5rem 0; padding-left: 1.2rem; color: #6c757d;">
                                    </ul>
                                </div>
                            </div>

                            <p style="font-size: 0.8rem; color: #6c757d; margin: 0; font-style: italic;">A frequ√™ncia
                                formativa influencia diretamente empregabilidade e mobilidade.</p>
                        </div>
                    </div>

                    <!-- NOVO: 4 Barras Verticais Douradas -->
                    <div class="analysis-block mb-4 p-3" style="background: white; border-radius: 8px;">
                        <h6
                            style="font-size: 0.95rem; font-weight: 600; color: #1A1A1A; margin-bottom: 1.5rem; text-align: center;">
                            Avalia√ß√£o Global do CV
                        </h6>
                        <div
                            style="display: flex; justify-content: space-around; align-items: flex-end; height: 200px; gap: 1rem;">

                            <!-- Barra 1: Estrutura -->
                            <div
                                style="flex: 1; display: flex; flex-direction: column; align-items: center; height: 100%;">
                                <div
                                    style="flex: 1; display: flex; flex-direction: column-reverse; width: 100%; max-width: 60px;">
                                    <div id="barEstrutura"
                                        style="background: linear-gradient(180deg, #BF9A33 0%, #D4AF37 100%); width: 100%; border-radius: 8px 8px 0 0; transition: height 0.8s ease; height: 0%;">
                                    </div>
                                </div>
                                <div style="margin-top: 0.5rem; font-size: 0.75rem; font-weight: 600; color: #6c757d;">
                                    Estrutura</div>
                                <div id="scoreEstrutura"
                                    style="font-size: 0.85rem; font-weight: 700; color: #BF9A33; margin-top: 0.25rem;">
                                    --</div>
                            </div>

                            <!-- Barra 2: Conte√∫do -->
                            <div
                                style="flex: 1; display: flex; flex-direction: column; align-items: center; height: 100%;">
                                <div
                                    style="flex: 1; display: flex; flex-direction: column-reverse; width: 100%; max-width: 60px;">
                                    <div id="barConteudo"
                                        style="background: linear-gradient(180deg, #BF9A33 0%, #D4AF37 100%); width: 100%; border-radius: 8px 8px 0 0; transition: height 0.8s ease; height: 0%;">
                                    </div>
                                </div>
                                <div style="margin-top: 0.5rem; font-size: 0.75rem; font-weight: 600; color: #6c757d;">
                                    Conte√∫do</div>
                                <div id="scoreConteudo"
                                    style="font-size: 0.85rem; font-weight: 700; color: #BF9A33; margin-top: 0.25rem;">
                                    --</div>
                            </div>

                            <!-- Barra 3: Forma√ß√£o -->
                            <div
                                style="flex: 1; display: flex; flex-direction: column; align-items: center; height: 100%;">
                                <div
                                    style="flex: 1; display: flex; flex-direction: column-reverse; width: 100%; max-width: 60px;">
                                    <div id="barFormacao"
                                        style="background: linear-gradient(180deg, #BF9A33 0%, #D4AF37 100%); width: 100%; border-radius: 8px 8px 0 0; transition: height 0.8s ease; height: 0%;">
                                    </div>
                                </div>
                                <div style="margin-top: 0.5rem; font-size: 0.75rem; font-weight: 600; color: #6c757d;">
                                    Forma√ß√£o</div>
                                <div id="scoreFormacao"
                                    style="font-size: 0.85rem; font-weight: 700; color: #BF9A33; margin-top: 0.25rem;">
                                    --</div>
                            </div>

                            <!-- Barra 4: Experi√™ncia -->
                            <div
                                style="flex: 1; display: flex; flex-direction: column; align-items: center; height: 100%;">
                                <div
                                    style="flex: 1; display: flex; flex-direction: column-reverse; width: 100%; max-width: 60px;">
                                    <div id="barExperiencia"
                                        style="background: linear-gradient(180deg, #BF9A33 0%, #D4AF37 100%); width: 100%; border-radius: 8px 8px 0 0; transition: height 0.8s ease; height: 0%;">
                                    </div>
                                </div>
                                <div style="margin-top: 0.5rem; font-size: 0.75rem; font-weight: 600; color: #6c757d;">
                                    Experi√™ncia</div>
                                <div id="scoreExperiencia"
                                    style="font-size: 0.85rem; font-weight: 700; color: #BF9A33; margin-top: 0.25rem;">
                                    --</div>
                            </div>

                        </div>
                    </div>

                    <!-- BLOCO 6: Estrutura Geral -->
                    <div class="analysis-block mb-4 p-3" style="background: white; border-radius: 8px;">
                        <h6 style="font-size: 0.95rem; font-weight: 600; color: #1A1A1A; margin-bottom: 1rem;">
                            <i class="fas fa-file-alt" style="color: #BF9A33; margin-right: 8px;"></i>
                            Estrutura do Documento
                        </h6>
                        <div style="font-size: 0.875rem; color: #495057; line-height: 1.7;">
                            <div class="mb-2"><strong>Organiza√ß√£o do CV:</strong> <span id="cvStructure">A
                                    verificar...</span></div>
                            <div class="mb-3"><strong>Legibilidade e hierarquia visual:</strong> <span
                                    id="readability">A analisar...</span></div>
                            <p style="font-size: 0.8rem; color: #6c757d; margin: 0; font-style: italic;">A estrutura
                                influencia a primeira impress√£o e facilidade de leitura.</p>
                        </div>
                    </div>

                    <!-- BLOCO 7: AN√ÅLISE ATS ISOLADA (NOVO) -->
                    <div id="atsDetailedSection" class="analysis-block mb-4 p-3"
                        style="background: white; border-radius: 8px; border: 2px solid #6c757d;">
                        <h6 style="font-size: 0.95rem; font-weight: 600; color: #1A1A1A; margin-bottom: 1rem;">
                            <i class="fas fa-robot" style="color: #BF9A33; margin-right: 8px;"></i>
                            An√°lise de Compatibilidade ATS
                        </h6>

                        <div style="text-align: center; margin-bottom: 1.25rem;">
                            <div id="atsScoreDisplay" style="font-size: 3rem; font-weight: 700; color: #6c757d;">--
                            </div>
                            <div style="font-size: 0.85rem; color: #6c757d;">/100</div>

                            <!-- Barra de Progresso ATS -->
                            <div style="width: 100%; max-width: 300px; margin: 0.75rem auto;">
                                <div style="background: #e9ecef; border-radius: 10px; height: 12px; overflow: hidden;">
                                    <div id="atsProgressBar"
                                        style="background: linear-gradient(90deg, #6c757d 0%, #6c757d 100%); height: 100%; width: 0%; border-radius: 10px; transition: width 1s ease-out, background 0.5s ease;">
                                    </div>
                                </div>
                            </div>

                            <div id="atsLevelBadge" class="badge px-3 py-2 mt-2"
                                style="background: #6c757d; color: white; font-size: 0.9rem;">
                                A calcular...
                            </div>
                        </div>

                        <div id="atsDiagnosticBox"
                            style="background: #f8f9fa; border-radius: 6px; padding: 1rem; margin-bottom: 1rem;">
                            <div style="font-size: 0.8rem; font-weight: 600; color: #1A1A1A; margin-bottom: 0.75rem;">
                                DIAGN√ìSTICO</div>
                            <ul id="atsLevelBullets" style="list-style: none; padding: 0; margin: 0;">
                                <li style="margin-bottom: 6px; font-size: 0.85rem; color: #495057;">A aguardar
                                    an√°lise...</li>
                            </ul>
                        </div>

                        <div id="atsTriggersBox" style="margin-top: 1rem;">
                            <div style="font-size: 0.8rem; font-weight: 600; color: #1A1A1A; margin-bottom: 0.75rem;">
                                GATILHOS DA PONTUA√á√ÉO</div>
                            <div id="atsTriggersList">
                                <div style="font-size: 0.85rem; color: #6c757d;">A identificar...</div>
                            </div>
                        </div>

                        <p
                            style="font-size: 0.75rem; color: #6c757d; margin: 1rem 0 0 0; font-style: italic; text-align: center;">
                            ATS (Applicant Tracking System) s√£o sistemas autom√°ticos de triagem de CVs usados por 75%
                            das empresas.
                        </p>
                    </div>

                    <!-- BLOCO VISUAL: Radar Chart -->
                    <div class="analysis-block mb-4 p-3" style="background: white; border-radius: 8px;">
                        <div class="chart-container" style="height: 280px;">
                            <canvas id="radarChart"></canvas>
                        </div>
                        <h6
                            style="font-size: 0.95rem; font-weight: 600; color: #1A1A1A; margin-bottom: 0.5rem; text-align: center;">
                            <i class="fas fa-chart-radar" style="color: #BF9A33; margin-right: 8px;"></i>
                            Avalia√ß√£o Global do CV
                        </h6>
                        <p
                            style="font-size: 0.8rem; color: #6c757d; text-align: center; margin: 0 0 0.75rem 0; font-style: italic;">
                            An√°lise em 6 dimens√µes: Estrutura, Conte√∫do, Impacto, Forma√ß√£o, Experi√™ncia e Compet√™ncias.
                        </p>
                    </div>

                    <!-- BLOCO FINAL: Teaser do Relat√≥rio -->
                    <div class="analysis-block p-4"
                        style="background: white; border-radius: 8px; border: 2px solid #BF9A33;">
                        <div style="text-align: center; color: #BF9A33; margin-bottom: 1rem;">
                            <i class="fas fa-file-alt" style="font-size: 2rem;"></i>
                        </div>
                        <h6
                            style="font-size: 1rem; font-weight: 600; color: #1A1A1A; text-align: center; margin-bottom: 0.75rem;">
                            O que n√£o est√° aqui</h6>
                        <p style="font-size: 0.875rem; color: #495057; text-align: center; margin-bottom: 1rem;">Esta √©
                            uma leitura inicial.<br>O relat√≥rio completo aprofunda decis√µes, riscos e oportunidades
                            espec√≠ficas do teu perfil.</p>
                        <div style="font-size: 0.875rem; color: #495057; margin-bottom: 1.25rem;">
                            <div style="margin-bottom: 0.5rem;"><strong>Inclui</strong></div>
                            <ul style="list-style: none; padding-left: 1rem; margin: 0;">
                                <li class="mb-1">‚Ä¢ Diagn√≥stico detalhado</li>
                                <li class="mb-1">‚Ä¢ Pontos fortes e fragilidades reais</li>
                                <li class="mb-1">‚Ä¢ Recomenda√ß√µes acion√°veis</li>
                                <li>‚Ä¢ Plano de evolu√ß√£o personalizado</li>
                            </ul>
                        </div>
                        <div style="text-align: center; margin-bottom: 1.25rem;">
                            <div style="font-size: 1.75rem; font-weight: 600; color: #BF9A33;">1,00 ‚Ç¨</div>
                            <div style="font-size: 0.85rem; color: #6c757d;">Relat√≥rio PDF enviado por email</div>
                        </div>
                    </div>

                </div>
                <div class="modal-footer bg-white border-top" style="padding: 1.25rem 2rem;">
                    <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-dismiss="modal"
                        style="border-radius: 6px;">Fechar</button>

                    <button type="button" class="btn btn-primary px-4" onclick="openReportPaymentModal()"
                        style="background: linear-gradient(135deg, #BF9A33 0%, #a57b0a 100%); border: none; border-radius: 6px; padding: 0.625rem 1.75rem; font-weight: 600;">
                        Desbloquear relat√≥rio completo
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Modal for 1‚Ç¨ PDF Report -->
    <div class="modal fade" id="reportPaymentModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" style="max-width: 500px;">
            <div class="modal-content" style="border-radius: 16px; border: none;">
                <div class="modal-header border-0">
                    <div style="text-align: center; width: 100%;">
                        <h5 class="modal-title fw-bold" style="font-size: 1.3rem; color: #1A1A1A;">An√°lise Autom√°tica de
                            CV</h5>
                        <p class="text-muted mb-0" style="font-size: 0.85rem;">Diagn√≥stico r√°pido baseado em IA</p>
                    </div>
                    <button type="button" class="btn-close position-absolute end-0 top-0 m-3"
                        data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body px-4 py-3">

                    <!-- Info Note -->
                    <div class="mb-3"
                        style="background: #f8f9fa; border-left: 3px solid #BF9A33; padding: 0.75rem; border-radius: 6px;">
                        <div style="display: flex; gap: 8px; align-items: start; font-size: 0.85rem; color: #1A1A1A;">
                            <span style="color: #BF9A33; flex-shrink: 0;">‚ë†</span>
                            <span>Sistema analisa estrutura, keywords e formata√ß√£o</span>
                        </div>
                        <div
                            style="display: flex; gap: 8px; align-items: start; font-size: 0.85rem; color: #1A1A1A; margin-top: 0.5rem;">
                            <span style="color: #BF9A33; flex-shrink: 0;">‚ë°</span>
                            <span>Recebes relat√≥rio PDF no email em segundos</span>
                        </div>
                        <small class="d-block mt-2" style="color: #6c757d; font-size: 0.75rem;">‚è± Tempo total: ~2
                            minutos</small>
                    </div>

                    <!-- PAYMENT FORM -->
                    <form id="reportPaymentForm">
                        <div class="mb-3">
                            <label class="form-label"
                                style="font-weight: 500; font-size: 0.9rem; color: #1A1A1A;">Nome</label>
                            <input type="text" class="form-control" id="paymentName" required
                                style="border: 1px solid #dee2e6; border-radius: 6px; padding: 0.6rem;">
                        </div>
                        <div class="mb-3">
                            <label class="form-label"
                                style="font-weight: 500; font-size: 0.9rem; color: #1A1A1A;">Email</label>
                            <input type="email" class="form-control" id="paymentEmail" required
                                style="border: 1px solid #dee2e6; border-radius: 6px; padding: 0.6rem;">
                        </div>
                        <div class="mb-3">
                            <label class="form-label"
                                style="font-weight: 500; font-size: 0.9rem; color: #1A1A1A;">Telem√≥vel</label>
                            <input type="tel" class="form-control" id="paymentPhone" required placeholder="961925050"
                                pattern="[0-9]{9}"
                                style="border: 1px solid #dee2e6; border-radius: 6px; padding: 0.6rem;">
                            <small class="form-text" style="font-size: 0.75rem; color: #6c757d; margin-top: 0.25rem;">
                                Pagamento seguro via MB WAY. Receber√°s notifica√ß√£o na app.
                            </small>
                        </div>

                        <div id="paymentStatusMsg" class="d-none"></div>

                        <button type="submit" class="btn w-100 mt-2 py-2" id="btnPayReport"
                            style="background: #BF9A33; border: none; color: #fff; font-weight: 600; font-size: 0.95rem; border-radius: 6px;">
                            Receber Relat√≥rio (1‚Ç¨ via MB WAY)
                        </button>
                    </form>

                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- PDF.js & Mammoth.js for Real File Reading -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Project Scripts -->
    <script src="../js/ifthenpay-integration.js"></script>
    <script src="../js/cv-engine.js"></script>
    <script src="../js/pdf-generator-modern.js"></script>

    <script>
        const fileInput = document.getElementById('cvFile');
        const fileNameDisplay = document.getElementById('fileName');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const btnSpinner = document.getElementById('btnSpinner');
        const btnText = document.getElementById('btnText');

        // Mostrar nome do ficheiro selecionado
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                fileNameDisplay.textContent = e.target.files[0].name;
                analyzeBtn.disabled = false;
            }
        });

        // Clique no Bot√£o Analisar - REAL FILE PROCESSING
        analyzeBtn.addEventListener('click', async () => {
            // UI Loading
            analyzeBtn.disabled = true;
            btnSpinner.classList.remove('d-none');
            btnText.textContent = 'A LER & ANALISAR...';

            const file = fileInput.files[0];

            if (file) {
                try {
                    // Chamar o Motor de An√°lise Real (PDF.js + Mammoth.js + Heuristics)
                    const success = await window.CV_ENGINE.analyzeFile(file);

                    if (success) {
                        // Abrir Modal com Resultados
                        const modal = new bootstrap.Modal(document.getElementById('resultsModal'));
                        modal.show();
                    }
                } catch (error) {
                    alert('Erro ao processar ficheiro: ' + error.message);
                    console.error('[CV ANALYSIS] Error:', error);
                }
            }

            // Reset UI
            analyzeBtn.disabled = false;
            btnSpinner.classList.add('d-none');
            btnText.textContent = 'INICIAR AN√ÅLISE IA';
        });

        // Nota: A fun√ß√£o renderRadarChart est√° agora definida no cv-engine.js
        // com os 6 novos fatores: Estrutura, Conte√∫do, Impacto, Forma√ß√£o, Experi√™ncia, Compet√™ncias

        // Open Payment Modal Function
        function openReportPaymentModal() {
            // Close results modal
            const resultsModalEl = document.getElementById('resultsModal');
            if (resultsModalEl) {
                const resultsModal = bootstrap.Modal.getInstance(resultsModalEl);
                if (resultsModal) resultsModal.hide();
            }

            // Open payment modal
            const paymentModal = new bootstrap.Modal(document.getElementById('reportPaymentModal'));
            paymentModal.show();
        }

        // Handle Payment Form Submission - USING IFTHENPAY INTEGRATION
        document.getElementById('reportPaymentForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();

            const name = document.getElementById('paymentName').value.trim();
            const email = document.getElementById('paymentEmail').value.trim();
            const phone = document.getElementById('paymentPhone').value.replace(/\D/g, ''); // Remove non-digits

            if (!name || !email || !phone) {
                alert('Por favor, preencha todos os campos.');
                return;
            }

            if (phone.length !== 9) {
                alert('O n√∫mero de telem√≥vel deve ter 9 d√≠gitos.');
                return;
            }

            const btnPayReport = document.getElementById('btnPayReport');
            const statusMsg = document.getElementById('paymentStatusMsg');
            const originalBtnText = btnPayReport.innerHTML;

            // Set loading state
            btnPayReport.disabled = true;
            btnPayReport.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> A processar...';
            statusMsg.classList.remove('d-none');
            statusMsg.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i> A iniciar pagamento MB WAY...</div>';

            try {
                // CRITICAL FIX: Call backend endpoint that SAVES analysis data before payment
                // This is necessary so the webhook can deliver the report after payment confirmation
                const BACKEND_URL = 'https://share2inspire-beckend.lm.r.appspot.com';
                const orderId = `CVA-${Date.now()}`;

                const requestData = {
                    name: name,
                    email: email,
                    phone: phone,
                    analysis_data: window.CV_ENGINE?.data || {}  // ‚úÖ Send analysis data to backend
                };

                console.log('üí≥ Sending payment request with analysis data to backend...');

                const response = await fetch(`${BACKEND_URL}/api/services/request-report-payment`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'Erro ao processar pagamento');
                }

                console.log('‚úÖ Payment initiated, analysis data saved:', result);

                // üîÑ START POLLING: Check payment status and trigger delivery
                const startPolling = (orderId) => {
                    let attempts = 0;
                    const maxAttempts = 30; // 5 minutes (10s intervals)

                    console.log(`üîÑ Starting polling for order: ${orderId}`);

                    const pollInterval = setInterval(async () => {
                        attempts++;
                        console.log(`üîÑ Poll attempt ${attempts}/${maxAttempts} for ${orderId}`);

                        try {
                            // Check payment status
                            const statusResponse = await fetch(`${BACKEND_URL}/api/payment/status/${orderId}`);
                            const statusData = await statusResponse.json();

                            if (statusData.success && statusData.record) {
                                const record = statusData.record;

                                // If paid and not yet delivered, trigger delivery
                                if (record.paid && !record.delivered) {
                                    console.log('‚úÖ Payment confirmed! Triggering delivery...');
                                    clearInterval(pollInterval);

                                    // Trigger manual delivery
                                    const deliveryResponse = await fetch(`${BACKEND_URL}/api/services/trigger-delivery/${orderId}`, {
                                        method: 'POST'
                                    });
                                    const deliveryData = await deliveryResponse.json();

                                    if (deliveryData.success) {
                                        console.log('üìß Report delivered successfully!');
                                        statusMsg.innerHTML = `
                                            <div class="alert alert-success">
                                                <strong>‚úÖ Pagamento confirmado!</strong><br>
                                                O relat√≥rio foi enviado para <strong>${email}</strong>
                                            </div>
                                        `;
                                    }
                                }

                                // If already delivered, stop polling
                                if (record.delivered) {
                                    console.log('üìß Report already delivered');
                                    clearInterval(pollInterval);
                                }
                            }

                            // Stop after max attempts
                            if (attempts >= maxAttempts) {
                                console.log('‚è± Polling timeout reached');
                                clearInterval(pollInterval);
                            }

                        } catch (error) {
                            console.warn(`Poll error:`, error);
                        }
                    }, 10000); // Poll every 10 seconds
                };

                // Start polling with the order ID
                startPolling(result.orderId);

                // Payment initiated successfully
                statusMsg.innerHTML = `
                    <div class="alert alert-success">
                        <i class="fas fa-mobile-alt me-2"></i>
                        <strong>Pedido MB WAY enviado!</strong><br>
                        <small>Por favor, confirme na sua aplica√ß√£o MB WAY. O relat√≥rio ser√° enviado ap√≥s confirma√ß√£o do pagamento.</small>
                    </div>
                `;

                // Show instructions
                setTimeout(() => {
                    statusMsg.innerHTML += `
                        <div class="alert alert-info mt-2">
                            <i class="fas fa-info-circle me-2"></i>
                            <small><strong>Pr√≥ximos passos:</strong><br>
                            1. Confirme o pagamento de 1‚Ç¨ na sua app MB WAY<br>
                            2. O relat√≥rio ser√° enviado automaticamente para <strong>${email}</strong> ap√≥s confirma√ß√£o</small>
                        </div>
                    `;
                }, 2000);

                // Reset button after delay
                setTimeout(() => {
                    btnPayReport.disabled = false;
                    btnPayReport.innerHTML = originalBtnText;
                }, 5000);

            } catch (error) {
                console.error('Payment Error:', error);
                statusMsg.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i> ${error.message}</div>`;
                btnPayReport.disabled = false;
                btnPayReport.innerHTML = originalBtnText;
            }
        });

        /* REMOVED: Polling functions - Backend handles this via Ifthenpay callbacks
        // Poll Payment Status
        async function pollPaymentStatus(orderId, name, email, backendUrl) {
            const statusMsg = document.getElementById('paymentStatusMsg');
            let pollCount = 0;
            const maxPolls = 60; // 3 minutes (3s * 60)

            const checkStatus = async () => {
                try {
                    const response = await fetch(`${backendUrl}/api/payment/status/${orderId}`);
                    const data = await response.json();

                    if (data.success && data.paid) {
                        // Payment confirmed!
                        statusMsg.innerHTML = `
                            <div class="alert alert-success">
                                <i class="fas fa-check-circle me-2"></i>
                                <strong>Pagamento confirmado!</strong><br>
                                <small>A gerar e enviar relat√≥rio PDF para ${email}...</small>
                            </div>
                        `;

                        // Trigger report delivery
                        await deliverPDFReport(name, email, backendUrl);

                        // Final success message
                        statusMsg.innerHTML = `
                            <div class="alert alert-success">
                                <i class="fas fa-envelope-open-text me-2"></i>
                                <strong>Relat√≥rio enviado com sucesso!</strong><br>
                                <small>Verifique o seu email ${email}</small>
                            </div>
                        `;

                        setTimeout(() => {
                            bootstrap.Modal.getInstance(document.getElementById('reportPaymentModal')).hide();
                        }, 4000);

                        return; // Stop polling
                    }

                    // Continue polling
                    pollCount++;
                    if (pollCount < maxPolls) {
                        setTimeout(checkStatus, 3000); // Check every 3 seconds
                    } else {
                        // Timeout
                        statusMsg.innerHTML += '<div class="alert alert-warning small mt-2">Tempo de espera excedido. Se confirmou o pagamento, receber√° o relat√≥rio por email em breve.</div>';
                    }

                } catch (error) {
                    console.error('Polling error:', error);
                }
            };

            // Start polling after 2 seconds
            setTimeout(checkStatus, 2000);
        }

        // Deliver PDF Report
        async function deliverPDFReport(name, email, backendUrl) {
            const reportData = window.CV_ENGINE?.data || {};

            await fetch(`${backendUrl}/api/services/deliver-cv-report`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name: name,
                    email: email,
                    report: reportData
                })
            });
        }
        */
    </script>
</body>

</html>